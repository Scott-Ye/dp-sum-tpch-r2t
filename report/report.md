# Instance-Optimal DP for SUM Queries over TPC-H – R2T with PostgreSQL & Python

- Student: Ye Huaxiang (ID: 21187411), MSc IT Fall 2025
- Title: Instance-Optimal DP for SUM Queries over TPC-H – Implementing R2T with PostgreSQL & Python

## Background

- Analytical queries on TPC-H; target is single-aggregate SUM version of Q3 by dropping GROUP BY.
- Differential privacy requires randomized perturbation while controlling utility; mechanism follows R2T-style truncated-sum with max selection over τ.

## Query and Data

- Target: TPC-H Q3 without GROUP BY returns a single revenue SUM defined by `SUM(l_extendedprice * (1 - l_discount))` after filters on segment, orderdate, shipdate.
- Database: PostgreSQL; synthetic dev data and instructions to load official TPC-H scale=1.

## Method

- Join extraction: run the 3-table join to collect per-order contributions `revenue`.
- LP construction: for each τ, solve a linear program maximizing `∑ x_i` subject to `0 ≤ x_i ≤ contrib_i` and `x_i ≤ τ`.
- Noise: add Laplace noise with scale `τ/ε` to the LP output.
- Selection: output is the maximum across a geometric grid of τ values.

## Privacy

- Each LP output with Laplace(`τ/ε`) is ε-DP for changes affecting a single contribution bounded by τ.
- Max selection over independent ε-DP estimates preserves ε-DP by post-processing.

## Experiments

- Accuracy: compare DP output to PostgreSQL baseline at snapshots; measure relative error.
- Throughput: simulate updates and report updates/s.
- Parameters: vary `ε ∈ {0.1, 0.5, 1, 2}`; plot error vs ε.

## Results

- Provide tables and plots generated by `r2t/benchmark.py` and a notebook.
- Expected: error decreases as ε increases; throughput scales with cores in update simulation.

## Discussion

- Bias-variance tradeoff governed by τ: small τ reduces sensitivity but increases truncation bias; selection mitigates.
- Foreign-key structure of Q3 concentrates contributions per order, making τ-capping natural.

## Conclusion

- Implemented an R2T-style pipeline on PostgreSQL achieving ε-DP for the SUM of Q3.
- The modular design supports swapping τ-grid and solver, and extending to MAX via ShiftedInverse.

## Reproducibility

- Configure PostgreSQL via env; run schema init, load data, and execute `run_r2t.py`, `benchmark.py`.

## References

- TPC-H specification and tools (current version 3.0.1).
- R2T and ShiftedInverse papers.
